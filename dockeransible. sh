#!/bin/bash
# ------------------------------------------------------------------
# Infra Docker VM Setup Script for Ubuntu 24.04
# Full setup: Docker, NAS, Swap, dependencies, Ansible, infra stack
# ------------------------------------------------------------------

# --- VARIABLES ---
NAS_IP="<NAS_IP>"             # Replace with your NAS IP
NAS_DOCKER_SHARE="/volume1/docker"
NAS_INFRA_SHARE="/volume1/infra"
GITHUB_DOCKER_REPO="https://github.com/<yourusername>/docker-repo.git"  # Replace with Docker repo URL
ANSIBLE_REPO="https://github.com/<yourusername>/ansible-repo.git"       # Replace with your Ansible repo
DOCKER_REPO_DIR="$HOME/docker-repo"
ANSIBLE_DIR="$HOME/ansible-repo"
ENV_FILE="$DOCKER_REPO_DIR/stacks/infra/.env"

DOCKER_DIR="/mnt/nas/docker/infra"
INFRA_DIR="/mnt/nas/infra"

PUID=1000
PGID=1000
TZ="Europe/London"

SWAP_FILE="/swapfile"
SWAP_SIZE="4G"

# --- UPDATE SYSTEM ---
echo "Updating system..."
sudo apt update && sudo apt upgrade -y

# --- INSTALL DEPENDENCIES ---
echo "Installing essential packages..."
sudo apt install -y curl wget git gnupg lsb-release ca-certificates nfs-common htop vim ansible

# --- CREATE SWAP FILE ---
if [ ! -f "$SWAP_FILE" ]; then
    echo "Creating $SWAP_FILE with size $SWAP_SIZE..."
    sudo fallocate -l $SWAP_SIZE $SWAP_FILE
    sudo chmod 600 $SWAP_FILE
    sudo mkswap $SWAP_FILE
    sudo swapon $SWAP_FILE
    echo "$SWAP_FILE none swap sw 0 0" | sudo tee -a /etc/fstab
else
    echo "Swap file already exists."
fi

# --- INSTALL DOCKER ---
echo "Installing Docker..."
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
  | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add user to docker group
sudo usermod -aG docker $USER
echo "Docker installed. Please log out and back in if this is the first time adding to the docker group."

# --- CREATE NAS MOUNT POINTS ---
echo "Creating NAS mount points..."
sudo mkdir -p $DOCKER_DIR
sudo mkdir -p $INFRA_DIR

# --- MOUNT NAS SHARES ---
echo "Mounting NAS shares..."
sudo mount -t nfs $NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR
sudo mount -t nfs $NAS_IP:$NAS_INFRA_SHARE $INFRA_DIR

# Add to fstab for persistence
grep -qxF "$NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR nfs defaults 0 0" /etc/fstab || \
    echo "$NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR nfs defaults 0 0" | sudo tee -a /etc/fstab
grep -qxF "$NAS_IP:$NAS_INFRA_SHARE $INFRA_DIR nfs defaults 0 0" /etc/fstab || \
    echo "$NAS_IP:$NAS_INFRA_SHARE $INFRA_DIR nfs defaults 0 0" | sudo tee -a /etc/fstab

# --- CLONE GITHUB DOCKER REPO ---
if [ ! -d "$DOCKER_REPO_DIR" ]; then
    echo "Cloning Docker GitHub repo..."
    git clone $GITHUB_DOCKER_REPO $DOCKER_REPO_DIR
else
    echo "Docker repo already exists, pulling latest..."
    cd $DOCKER_REPO_DIR
    git pull
fi

# --- CLONE ANSIBLE REPO ---
if [ ! -d "$ANSIBLE_DIR" ]; then
    echo "Cloning Ansible repo..."
    git clone $ANSIBLE_REPO $ANSIBLE_DIR
else
    echo "Ansible repo already exists, pulling latest..."
    cd $ANSIBLE_DIR
    git pull
fi

# --- CONFIGURE .env ---
echo "Configuring .env for infra VM..."
cat > $ENV_FILE <<EOL
PUID=$PUID
PGID=$PGID
TZ=$TZ
DockerDir=$DOCKER_DIR
InfraDir=$INFRA_DIR
EOL

# --- DEPLOY INFRA STACK ---
echo "Deploying infra stack..."
cd $DOCKER_REPO_DIR/stacks/infra
docker compose up -d

echo "Infra Docker VM setup complete!"
echo "Verify containers with: docker ps"
echo "Ansible repo is at: $ANSIBLE_DIR"
