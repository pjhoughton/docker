#!/bin/bash
# ------------------------------------------------------------------
# IoT Docker VM Setup Script for Ubuntu 24.04
# Full setup: Docker, NAS, Swap, dependencies, media stack
# ------------------------------------------------------------------

# --- VARIABLES ---
NAS_IP="<NAS_IP>"             # Replace with your NAS IP
NAS_DOCKER_SHARE="/volume1/docker"
NAS_MEDIA_SHARE="/volume1/media"
NAS_DOWNLOADS_SHARE="/volume1/downloads"
GITHUB_REPO="https://github.com/<yourusername>/docker-repo.git"  # Replace with your repo URL
REPO_DIR="$HOME/docker-repo"
ENV_FILE="$REPO_DIR/stacks/media/.env"

DOCKER_DIR="/mnt/nas/docker/media"
MEDIA_DIR="/mnt/nas/media"
DOWNLOADS_DIR="/mnt/nas/downloads"

PUID=1000
PGID=1000
TZ="Europe/London"

SWAP_FILE="/swapfile"
SWAP_SIZE="4G"  # Adjust size as needed

# --- UPDATE SYSTEM ---
echo "Updating system..."
sudo apt update && sudo apt upgrade -y

# --- INSTALL DEPENDENCIES ---
echo "Installing essential packages..."
sudo apt install -y curl wget git gnupg lsb-release ca-certificates nfs-common htop vim

# --- CREATE SWAP FILE ---
if [ ! -f "$SWAP_FILE" ]; then
    echo "Creating $SWAP_FILE with size $SWAP_SIZE..."
    sudo fallocate -l $SWAP_SIZE $SWAP_FILE
    sudo chmod 600 $SWAP_FILE
    sudo mkswap $SWAP_FILE
    sudo swapon $SWAP_FILE
    echo "$SWAP_FILE none swap sw 0 0" | sudo tee -a /etc/fstab
else
    echo "Swap file already exists."
fi

# --- INSTALL DOCKER ---
echo "Installing Docker..."
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
  | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add user to docker group
sudo usermod -aG docker $USER
echo "Docker installed. Please log out and back in if this is the first time adding to the docker group."

# --- CREATE NAS MOUNT POINTS ---
echo "Creating NAS mount points..."
sudo mkdir -p $DOCKER_DIR
sudo mkdir -p $MEDIA_DIR
sudo mkdir -p $DOWNLOADS_DIR

# --- MOUNT NAS SHARES ---
echo "Mounting NAS shares..."
sudo mount -t nfs $NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR
sudo mount -t nfs $NAS_IP:$NAS_MEDIA_SHARE $MEDIA_DIR
sudo mount -t nfs $NAS_IP:$NAS_DOWNLOADS_SHARE $DOWNLOADS_DIR

# Add to fstab for persistence
grep -qxF "$NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR nfs defaults 0 0" /etc/fstab || \
    echo "$NAS_IP:$NAS_DOCKER_SHARE $DOCKER_DIR nfs defaults 0 0" | sudo tee -a /etc/fstab
grep -qxF "$NAS_IP:$NAS_MEDIA_SHARE $MEDIA_DIR nfs defaults 0 0" /etc/fstab || \
    echo "$NAS_IP:$NAS_MEDIA_SHARE $MEDIA_DIR nfs defaults 0 0" | sudo tee -a /etc/fstab
grep -qxF "$NAS_IP:$NAS_DOWNLOADS_SHARE $DOWNLOADS_DIR nfs defaults 0 0" /etc/fstab || \
    echo "$NAS_IP:$NAS_DOWNLOADS_SHARE $DOWNLOADS_DIR nfs defaults 0 0" | sudo tee -a /etc/fstab

# --- CLONE GITHUB REPO ---
if [ ! -d "$REPO_DIR" ]; then
    echo "Cloning GitHub repo..."
    git clone $GITHUB_REPO $REPO_DIR
else
    echo "Repo already exists, pulling latest..."
    cd $REPO_DIR
    git pull
fi

# --- CONFIGURE .env ---
echo "Configuring .env for media VM..."
cat > $ENV_FILE <<EOL
PUID=$PUID
PGID=$PGID
TZ=$TZ
DockerDir=$DOCKER_DIR
MediaDir=$MEDIA_DIR
DownloadsDir=$DOWNLOADS_DIR
EOL

# --- DEPLOY MEDIA STACK ---
echo "Deploying media stack..."
cd $REPO_DIR/stacks/media
docker compose up -d

echo "IoT Docker VM setup complete!"
echo "Verify containers with: docker ps"
